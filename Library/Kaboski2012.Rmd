---
pagetitle: 'Kaboski and Townsend (2012)'
author: ""
date: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R replication of tables in Kaboski and Townsend (2012), "The Impact of Credit on Village Economies"

```{r, warning = FALSE}
# Install and load packages ---------------
packages <- c(
  "tidyverse",
  "haven",
  "lfe",
  "car",
  "broom",
  "stargazer",
  "broom",
  "kableExtra",
  "labelled",
  "XML",
  "scales",
  "magrittr"
)

pacman::p_load(packages, character.only = TRUE, install = TRUE)

# Load an example dataset ---------------
data_short <- read_dta("Kaboski2012_replication/AEJApp2009-0115_data/documentation/AnnualData_ShortSample.dta")
```

## Table 1

```{r}

data_table1 <- data_short %>% 
  mutate(
    vfstn = ifelse(year %in% c(6, 7), vfst, NA),
    vfstp = (vfst > 0),
    vfstpn = ifelse(year %in% c(6, 7), vfstp, NA),
    defcrp = (defcr > 0),
    bsnew = bnew + snew,
    tbinv = pinv + binv + bafdn + sinv + safdn,
    twage = frmwage + shrwage + buswage,
    farm = ifelse(
      !is.na(och),
      ifelse((och > -5) & (och <= 15), 1, 0),
      0
    ),
    age2h = ageh^2
  ) %>% 
  group_by(case_id) %>% 
  mutate(
    invHHi = mean(ifelse(year == 6, lead(1 / vHH), NA), na.rm = TRUE)
  ) %>% 
  ungroup()


```

```{r}

credit_varlist <- c(
  "newst", "vfstn", "vfstpn", "baacst", "cbst", "infst", 
  "agst", "busst", "frtst", "const"
)

credit_market_varlist <- c(
  "rst", "defcrp"
)

cons_varlist <- c(
  "tc", "educ", "grain", "milk", "meat", "alch1", 
  "alch2", "fuel", "tobac", "cerem", "houserep", "vehicrep", 
  "clothes", "mealaway"
)

inc_varlist <- c(
  "netinc", "buspro", "wageinc", 
  "riceinc", "cropinc", "liveinc", "gassd"
)

invest_varlist <- c(
 "bsnew", "tbinv", "finv",
 "frtexp", "twage"
)

other_varlist <- c(
  "maleh", "ageh", "educh",
  "madult", "fadult", "kids", "farm"
)

iv_varlist <- c(
  "invHHi"
  )

all_varlist <- c(
  credit_varlist, credit_market_varlist, cons_varlist, inc_varlist,
  invest_varlist, other_varlist, iv_varlist
)

var_label_list <- c(
  "New short-term credit (total)", "Village fund credit, post-program",
  "Village fund loan received dummy, post-program",
  "BAAC/ag coop credit", "Commercial bank credit",
  "Informal credit", "Credit for agricultural investment",
  "Credit for business investment", "Credit for fertilizer, pesticides, etc.",
  "Credit for consumption", "Average short-term credit interest rate",
  "Dummy for credit in default", "Total consumption",
  "Education", "Grain", "Dairy", "Meat", "Alcohol at home",
  "Alcohol out of home", "Fuel", "Tobacco", "Ceremony", "House repair", 
  "Vehicle repair", "Clothes", "Eating out", "(Total) net income", "Business income",
  "Wage and salary income", "Gross income from rice farming", 
  "Gross income from other crops", "Gross income from livestock", 
  "Gross assets (incl. savings)", "Number of new businesses", "Business investment",
  "Agricultural investment", "Expenditure on fertilizer, pesticides, etc.",
  "Total wages paid", "Male head of household dummy", "Age of head",
  "Years of education of head", "Male adults in household",
  "Female adults in household", "Kids in household",
  "Farming dummy for household head's\n\\hspace{1em}primary occupation",
  "Inverse village size"
)

base_sumstat <- data_table1 %>% 
  select(all_of(all_varlist)) %>% 
  map( ~ tibble(
    obs = format(sum(!is.na(.x)), digits = 0, format = "f", big.mark = ","),
    mean_var = mean(.x, na.rm = TRUE), 
    sd_var = sd(.x, na.rm = TRUE)
    )
    ) %>% 
  tibble() %>% 
  unnest(".")

cross_sectional_sd <- data_table1 %>% 
  group_by(case_id) %>% 
  select(all_of(all_varlist)) %>% 
  summarise_all(mean, na.rm = TRUE) %>% 
  ungroup() %>% 
  select(-case_id) %>% 
  map( ~ tibble(
    cross_section_sd_var = sd(.x, na.rm = TRUE)
    )
    ) %>% 
  tibble() %>% 
  unnest(".")
  
cbind(var_label_list, base_sumstat, cross_sectional_sd) %>% 
  mutate_if(is.double, ~ ifelse(
    .x >= 100,
    comma_format(accuracy = 1e+2)(.x),
    comma_format(accuracy = 1e-2)(.x)
    )
    ) %>% 
  mutate(var_label_list = linebreak(var_label_list, align = "l")) %>% 
  set_colnames(NULL) %>%
  kable("latex", booktabs = TRUE, escape = FALSE, align = c("l", rep("r", 4))) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_header_above(
    c(" ", "Observations", "Mean", "SD", "Cross-sectional\nSD")
    ) %>%
  pack_rows(index = c(
    "Short-term credit variables" = length(credit_varlist),
    "Credit market indicators" = length(credit_market_varlist),
    "Consumption variables" = length(cons_varlist),
    "Income and asset variables" = length(inc_varlist),
    "Investment and input uses variables" = length(invest_varlist),
    "Other control variables" = length(other_varlist),
    "Instrument" = length(iv_varlist)
    )) %>%
  save_kable("tex/Kaboski2012_table1_replicate.tex")
  
```


```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "hide"}
file.copy(
  "tex/Kaboski2012_table1_replicate.tex",
  "tex/Kaboski2012_table1_replicate_doc.tex",
  overwrite = TRUE
  )

fConn <- file("tex/Kaboski2012_table1_replicate_doc.tex", "r+")
Lines <- readLines(fConn)
writeLines(
  c(
    "\\documentclass{report}", 
    "\\usepackage[paperwidth=5.5in,paperheight=7in,noheadfoot,margin=0in]{geometry}",
    "\\usepackage{float}",
    "\\usepackage{pdflscape}",
    "\\usepackage{makecell}",
    "\\usepackage{booktabs}",
    "\\usepackage{multicol}",
    "\\begin{document}\\pagestyle{empty}",
    Lines,
    "\\end{document}"
    ), 
  con = fConn
  )
close(fConn)

tools::texi2dvi(file = "tex/Kaboski2012_table1_replicate_doc.tex")
cmd <- paste(
  "dvipng -T tight", 
  shQuote("Kaboski2012_table1_replicate_doc.dvi"),
  "-o", shQuote("table_figures/Kaboski2012_table1_replicate.png")
  )
invisible(system(cmd))
cleaner <- c(".aux", ".log", ".dvi")
invisible(file.remove(paste0("Kaboski2012_table1_replicate_doc", cleaner)))

```

![](table_figures/Kaboski2012_table1_replicate.png){width=100%}

## Table 2

```{r}

data_table2 <- data_short %>% 
  group_by(case_id) %>% 
  mutate(
    invHH = ifelse(year == 1, lead(1 / vHH), 1 / vHH),
    invHHim = ifelse(year == 6, invHH, NA),
    invHHi = mean(invHHim, na.rm = TRUE),
    vHHi = 1 / invHHi,
    invHHpvf = invHHi * (year > 5),
    invHHtvf1 = invHHi * (year == 6),
    invHHtvf2 = invHHi * (year == 7),
    vfst = vfst / 10000,
    villageyear = floor(case_id / 1000),
    farm = ifelse(
      !is.na(och),
      ifelse((och > -5) & (och <= 15), 1, 0),
      0
    ),
    age2h = ageh^2
  ) %>% 
  ungroup() %>% 
  filter(
    year < 8,
    vHHi <= 250,
    vHHi >= 50
    )

res_table2 <- felm(
  newst ~ as.factor(year) + madult + fadult + kids + maleh + farm + ageh + age2h + educh | 
    case_id | (vfst ~ invHHtvf1 + invHHtvf2) | villageyear,
  data = data_table2
)

table2_1st <- summary(res_table2$stage1)$coefficients[,1:3] %>% 
  as_tibble() %>% 
  mutate(
    Estimate = Estimate * 10000,
    `Cluster s.e.` = `Cluster s.e.` * 10000,
    across(
      .cols = everything(),
      .fns = function(x) ifelse(
        abs(x) > 10,
        comma_format(accuracy = 1e+1)(x),
        comma_format(accuracy = 1e-2)(x)
      ),
      .names = "{col}_format"
    ),
    Estimate_format = ifelse(
      abs(`t value`) > 2.58,
      paste0(Estimate_format, "***"),
      ifelse(
        abs(`t value`) > 1.96,
        paste0(Estimate_format, "**"),
        ifelse(
          abs(`t value`) > 1.64,
          paste0(Estimate_format, "*"),
          Estimate_format
        )
      )
    )
  ) %>% 
  select(Estimate_format, `Cluster s.e._format`, `t value_format`)

table2_2nd <- summary(res_table2)$coefficients[,1:3] %>% 
  as_tibble() %>% 
  mutate(
    across(
      .cols = everything(),
      .fns = function(x) ifelse(
        abs(x) > 10,
        comma_format(accuracy = 1e+1)(x),
        comma_format(accuracy = 1e-2)(x)
      ),
      .names = "{col}_format"
    ),
    Estimate_format = ifelse(
      abs(`t value`) > 2.58,
      paste0(Estimate_format, "***"),
      ifelse(
        abs(`t value`) > 1.96,
        paste0(Estimate_format, "**"),
        ifelse(
          abs(`t value`) > 1.64,
          paste0(Estimate_format, "*"),
          Estimate_format
        )
      )
    )
  ) %>% 
  select(Estimate_format, `Cluster s.e._format`, `t value_format`)

cont_label_list <- c(
  "Year = 1998 dummy",  "Year = 1999 dummy",  "Year = 2000 dummy", 
  "Year = 2001 dummy",  "Year = 2002 dummy",  "Year = 2003 dummy", 
  "Adult males in household", "Adult females in household",
  "Children ($<$ 18 years) in household", "Male head of household",
  "Head of household's primary occupation is farming",
  "Age of head", "Age of head squared", "Years of education - head of household"
)

iv_label_list <- c(
  "\\textit{Interaction of inverse village size and year = 2002 dummy}",
  "\\textit{Interaction of inverse village size and year = 2003 dummy}"
)

main_rhs_list <- c(
  "\\textit{Village fund credit (predicted) / 10,000}"
)

table2_obs <- paste0(
  comma_format(accuracy = 1e+1)(nrow(model.frame(res_table2))),
  "/",
  comma_format(accuracy = 1e+0)(
    n_distinct(model.frame(res_table2)$case_id) -
    sum(table(model.frame(res_table2)$case_id) == 1)
    )
)

rbind(
  cbind(col_names = c(cont_label_list, iv_label_list), table2_1st),
  c("Observations / groups", "",  table2_obs, ""),
  cbind(col_names = c(cont_label_list, main_rhs_list), table2_2nd),
  c("Observations / groups", "",  table2_obs, "")
  ) %>% 
  set_colnames(NULL) %>%
  kable("latex", booktabs = TRUE, escape = FALSE, align = c("l", "c", rep("r", 2))) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_header_above(
    c(" ", "Coeff.", "SE", "$z$-statistic"),
    escape = FALSE
    ) %>%
  pack_rows(index = c(
    "First stage: village fund credit on instruments" = 
      length(c(cont_label_list, iv_label_list)) + 1,
    "Second stage: new short-term credit on predicted village fund credit" = 
      length(c(cont_label_list, main_rhs_list)) + 1
    )) %>%
  save_kable("tex/Kaboski2012_table2_replicate.tex")
  
```

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "hide"}
file.copy(
  "tex/Kaboski2012_table2_replicate.tex",
  "tex/Kaboski2012_table2_replicate_doc.tex",
  overwrite = TRUE
  )

fConn <- file("tex/Kaboski2012_table2_replicate_doc.tex", "r+")
Lines <- readLines(fConn)
writeLines(
  c(
    "\\documentclass{report}", 
    "\\usepackage[paperwidth=5.5in,paperheight=7in,noheadfoot,margin=0in]{geometry}",
    "\\usepackage{float}",
    "\\usepackage{pdflscape}",
    "\\usepackage{makecell}",
    "\\usepackage{booktabs}",
    "\\usepackage{multicol}",
    "\\begin{document}\\pagestyle{empty}",
    Lines,
    "\\end{document}"
    ), 
  con = fConn
  )
close(fConn)

tools::texi2dvi(file = "tex/Kaboski2012_table2_replicate_doc.tex")
cmd <- paste(
  "dvipng -T tight", 
  shQuote("Kaboski2012_table2_replicate_doc.dvi"),
  "-o", shQuote("table_figures/Kaboski2012_table2_replicate.png")
  )
invisible(system(cmd))
cleaner <- c(".aux", ".log", ".dvi")
invisible(file.remove(paste0("Kaboski2012_table2_replicate_doc", cleaner)))

```

![](table_figures/Kaboski2012_table2_replicate.png){width=100%}

## Functions for Tables 3-8

```{r}

reg_func <- function(varlist, filterlist, iv, data) {
  varlist %>% 
    enframe("model_no", "outcome") %>% 
    mutate(filter = filterlist) %>% 
    mutate(
      model = map2(outcome, filter, function(x, y) felm(
        formula(
          paste0(
            x, 
            "~ as.factor(year) + madult + fadult + kids + maleh + farm + ageh + age2h + educh | ",
            "case_id | ", iv, " | villageyear"
          )
        ),
        data = y(data)
      ))
    )
}

table_arrange <- function(reg_output) {
  
  main_rhs = "`vfst(fit)`"
  
  reg_output %>% 
    mutate(
      coef = map_chr(model, function(x) ifelse(
        abs(x$coefficients[main_rhs, 1]) > 50,
        comma_format(accuracy = 1e+2)(x$coefficients[main_rhs, 1]),
        ifelse(
          abs(x$coefficients[main_rhs, 1]) > 5,
          comma_format(accuracy = 1e+1)(x$coefficients[main_rhs, 1]),
          comma_format(accuracy = 1e-3)(x$coefficients[main_rhs, 1])
        )
      )),
      pval = map_dbl(model, ~ .x$cpval[main_rhs]),
      coef = ifelse(
        pval < 0.01,
        paste0(coef, "***"),
        ifelse(
          pval < 0.05,
          paste0(coef, "**"),
          ifelse(
            pval < 0.10,
            paste0(coef, "*"),
            coef
          )
        )
      ),
      se = paste0(
        "(", 
        map_chr(model, function(x) ifelse(
          abs(x$cse[main_rhs]) > 50,
          comma_format(accuracy = 1e+2)(x$cse[main_rhs]),
          ifelse(
            abs(x$cse[main_rhs]) > 5,
            comma_format(accuracy = 1e+1)(x$cse[main_rhs]),
            comma_format(accuracy = 1e-3)(x$cse[main_rhs])
          )
        )),
        ")"
      )
    ) %>% 
    select(coef, se) %>% 
    as.matrix() %>% 
    t()
}




```

## Table 3


```{r}

table3_outcome_list <- c(
  "newst", "tc", "dlgassd", "dnetinc"
)

data_table3 <- data_short %>% 
  group_by(case_id) %>% 
  mutate(
    farm = ifelse(
      !is.na(och),
      ifelse((och > -5) & (och <= 15), 1, 0),
      0
    ),
    age2h = ageh^2,
    vfst = vfst / 10000,
    villageyear = floor(case_id / 1000),
    invHH = ifelse(year == 1, lead(1 / vHH), 1 / vHH),
    invHHim = ifelse(year == 6, invHH, NA),
    invHHi = mean(invHHim, na.rm = TRUE),
    vHHi = 1 / invHHi,
    invHHpvf = invHHi * (year > 5),
    invHHtvf1 = invHHi * (year == 6),
    invHHtvf2 = invHHi * (year == 7),
    dlgassd = log(lead(gassd) / gassd),
    dnetinc = ifelse(
      is.infinite(log(lead(netinc) / netinc)),
      NA,
      log(lead(netinc) / netinc)
    )
  ) %>% 
  ungroup() %>% 
  filter(year < 8)
  
table3_filter_list <- list(
  function (x) {filter(
    x, newst <= 315000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, tc >= 4430, tc <= 433000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, dlgassd >= -2.565758, dlgassd <= 2.494314,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, dnetinc >= -2.605709, dnetinc <= 2.848096,
    vHHi < 250, vHHi >= 50, year < 8
    )}
)

table3_ols_output <- reg_func(
  table3_outcome_list, 
  replicate(
    length(table3_outcome_list), 
    function(x) {filter(x, vHHi < 250, vHHi >= 50, year < 8)}
    ),
  "(vfst ~ vfst)",
  data_table3
  ) %>% 
  table_arrange()

table3_baseline_iv_output <- reg_func(
  table3_outcome_list, 
  replicate(
    length(table3_outcome_list), 
    function(x) {filter(x, vHHi < 250, vHHi >= 50, year < 8)}
    ),
  "(vfst ~ invHHtvf1 + invHHtvf2)",
  data_table3
  ) %>% 
  table_arrange()

table3_all_iv_output <- reg_func(
  table3_outcome_list, 
  replicate(
    length(table3_outcome_list), 
    function(x) {filter(x, year < 8)}
    ),
  "(vfst ~ invHHtvf1 + invHHtvf2)",
  data_table3
  ) %>% 
  table_arrange()

table3_no_outlier_iv_output <- reg_func(
  table3_outcome_list, 
  table3_filter_list,
  "(vfst ~ invHHtvf1 + invHHtvf2)",
  data_table3
  ) %>% 
  table_arrange()

c(
  "OLS regression", "",
  "Baseline IV regression: only villages", "\\hspace{1em}with 50-200 households",
  "IV regression using all villages", "",
  "IV regression without 1\\% outliers", ""
  ) %>% 
  cbind(
    rbind(
      table3_ols_output,
      table3_baseline_iv_output,
      table3_all_iv_output,
      table3_no_outlier_iv_output
    )
  ) %>% 
  as_tibble() %>% 
  mutate_all(linebreak, align = "l") %>% 
  set_names(NULL) %>% 
  kable(
    "latex", booktabs = TRUE, escape = FALSE, 
    align = c("l", rep("c", length(table3_outcome_list)))
    ) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_header_above(
    c(
      "Response variable", "Net short-term\ncreidt level", 
      "Consumption\nlevel", "Asset\ngrowth rate", 
      "Net income\ngrowth rate"
      )
    ) %>%
  pack_rows(index = c(
    "Technique" = 8
    )) %>%
  save_kable("tex/Kaboski2012_table3_replicate.tex")
  

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "hide"}
file.copy(
  "tex/Kaboski2012_table3_replicate.tex",
  "tex/Kaboski2012_table3_replicate_doc.tex",
  overwrite = TRUE
  )

fConn <- file("tex/Kaboski2012_table3_replicate_doc.tex", "r+")
Lines <- readLines(fConn)
writeLines(
  c(
    "\\documentclass{report}", 
    "\\usepackage[paperwidth=5.5in,paperheight=7in,noheadfoot,margin=0in]{geometry}",
    "\\usepackage{float}",
    "\\usepackage{pdflscape}",
    "\\usepackage{makecell}",
    "\\usepackage{booktabs}",
    "\\usepackage{multicol}",
    "\\begin{document}\\pagestyle{empty}",
    Lines,
    "\\end{document}"
    ), 
  con = fConn
  )
close(fConn)

tools::texi2dvi(file = "tex/Kaboski2012_table3_replicate_doc.tex")
cmd <- paste(
  "dvipng -T tight", 
  shQuote("Kaboski2012_table3_replicate_doc.dvi"),
  "-o", shQuote("table_figures/Kaboski2012_table3_replicate.png")
  )
invisible(system(cmd))
cleaner <- c(".aux", ".log", ".dvi")
invisible(file.remove(paste0("Kaboski2012_table3_replicate_doc", cleaner)))

```

![](table_figures/Kaboski2012_table3_replicate.png){width=100%}

## Table 4

```{r}

table4_outcome_list <- c(
  "newst", "baacst", "cbst", "agst",
  "busst", "frtst", "const"
)

data_table4 <- data_short %>% 
  group_by(case_id) %>% 
  mutate(
    farm = ifelse(
      !is.na(och),
      ifelse((och > -5) & (och <= 15), 1, 0),
      0
    ),
    age2h = ageh^2,
    vfst = vfst / 10000,
    villageyear = floor(case_id / 1000),
    invHH = ifelse(year == 1, lead(1 / vHH), 1 / vHH),
    invHHim = ifelse(year == 6, invHH, NA),
    invHHi = mean(invHHim, na.rm = TRUE),
    vHHi = 1 / invHHi,
    invHHpvf = invHHi * (year > 5),
    invHHtvf1 = invHHi * (year == 6),
    invHHtvf2 = invHHi * (year == 7),
    dlgassd = log(lead(gassd) / gassd),
    dnetinc = ifelse(
      is.infinite(log(lead(netinc) / netinc)),
      NA,
      log(lead(netinc) / netinc)
    )
  ) %>% 
  ungroup()
  
table4_filter_list <- list(
  function (x) {filter(
    x, newst <= 315000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, baacst <= 240000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, cbst <= 300000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, agst <= 170000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, busst <= 750000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, frtst <= 300000,
    vHHi < 250, vHHi >= 50, year < 8
    )},
  function (x) {filter(
    x, const <= 170000,
    vHHi < 250, vHHi >= 50, year < 8
    )}
)

table4_ols_output <- reg_func(
  table4_outcome_list, 
  replicate(
    length(table4_outcome_list), 
    function(x) {filter(x, vHHi < 250, vHHi >= 50, year < 8)}
    ),
  "(vfst ~ vfst)",
  data_table4
  ) %>% 
  table_arrange()

table4_baseline_iv_output <- reg_func(
  table4_outcome_list, 
  replicate(
    length(table4_outcome_list), 
    function(x) {filter(x, vHHi < 250, vHHi >= 50, year < 8)}
    ),
  "(vfst ~ invHHtvf1 + invHHtvf2)",
  data_table4
  ) %>% 
  table_arrange()

table4_all_iv_output <- reg_func(
  table4_outcome_list, 
  replicate(
    length(table4_outcome_list), 
    function(x) {filter(x, year < 8)}
    ),
  "(vfst ~ invHHtvf1 + invHHtvf2)",
  data_table4
  ) %>% 
  table_arrange()

table4_no_outlier_iv_output <- reg_func(
  table4_outcome_list, 
  table4_filter_list,
  "(vfst ~ invHHtvf1 + invHHtvf2)",
  data_table4
  ) %>% 
  table_arrange()

c(
  "OLS regression", "",
  "Baseline IV regression:", "\\hspace{1em}only villages\n\\hspace{1em}with 50-200 households",
  "IV regression using", "\\hspace{1em}all villages",
  "IV regression without", "\\hspace{1em} 1\\% outliers"
  ) %>% 
  cbind(
    rbind(
      table4_ols_output,
      table4_baseline_iv_output,
      table4_all_iv_output,
      table4_no_outlier_iv_output
    )
  ) %>% 
  as_tibble() %>% 
  mutate_all(linebreak, align = "l") %>% 
  set_names(NULL) %>% 
  kable(
    "latex", booktabs = TRUE, escape = FALSE, 
    align = c("l", rep("c", length(table4_outcome_list)))
    ) %>%
  kable_styling(latex_options = "scale_down") %>%
  add_header_above(
    c(
      "Response variable", "Net short-term\ncreidt level", 
      "BAAC/ag\ncoop credit", "Commercial\nbank credit", 
      "Credit for\nagricultural\ninvestment",
      "Credit for\nbusiness\ninvestment",
      "Credit for\nfert., pest.,\netc.",
      "Credit\nfor\nconsumption"
      )
    ) %>%
  add_header_above(c(
    " " = 1, 
    " " = 1, 
    "Other formal credit" = 2, 
    "Stated reasons for borrowing" = 4
    )) %>%
  pack_rows(index = c(
    "Technique" = 8
    )) %>%
  save_kable("tex/Kaboski2012_table4_replicate.tex")
  

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "hide"}
file.copy(
  "tex/Kaboski2012_table4_replicate.tex",
  "tex/Kaboski2012_table4_replicate_doc.tex",
  overwrite = TRUE
  )

fConn <- file("tex/Kaboski2012_table4_replicate_doc.tex", "r+")
Lines <- readLines(fConn)
writeLines(
  c(
    "\\documentclass{report}", 
    "\\usepackage[paperwidth=5.5in,paperheight=7in,noheadfoot,margin=0in]{geometry}",
    "\\usepackage{float}",
    "\\usepackage{pdflscape}",
    "\\usepackage{makecell}",
    "\\usepackage{booktabs}",
    "\\usepackage{multicol}",
    "\\begin{document}\\pagestyle{empty}",
    Lines,
    "\\end{document}"
    ), 
  con = fConn
  )
close(fConn)

tools::texi2dvi(file = "tex/Kaboski2012_table4_replicate_doc.tex")
cmd <- paste(
  "dvipng -T tight", 
  shQuote("Kaboski2012_table4_replicate_doc.dvi"),
  "-o", shQuote("table_figures/Kaboski2012_table4_replicate.png")
  )
invisible(system(cmd))
cleaner <- c(".aux", ".log", ".dvi")
invisible(file.remove(paste0("Kaboski2012_table4_replicate_doc", cleaner)))

```

![](table_figures/Kaboski2012_table4_replicate.png){width=100%}
